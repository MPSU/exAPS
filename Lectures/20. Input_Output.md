# Лекция 20. Ввод\Вывод

## СОДЕРЖАНИЕ
* [Сисмемы ввода-вывод](#Сисмемы-ввода-вывод)
* [Структура периферийного устройства](#Структура-периферийного-устройства)
* [Модули ввода-вывода](#Модули-ввода-вывода)
* [Структура модуля ввода-вывода](#Структура-модуля-ввода-вывода)
* [Методы управления вводом-выводом](#Методы-управления-вводом-выводом)
* [Конфигурации ПДП(DMA)](#Конфигурации-ПДП(DMA))
* [Канальная система ввода-вывода](#Канальная-система-ввода-вывода)
* [RAID](#RAID)
* [JTAG (Join Test Action Group)](#JTAG-(Join-Test-Action-Group))
* [Основные материалы лекции](#Основные-материалы-лекции)
* [Дополнительные материалы к лекции](#Дополнительные-материалы-к-лекции)

## Сисмемы ввода-вывода:
- Системы выделенным адресным пространством:

![](../../ПМ/pictures/lecture20/pic4.png)


- Системы с совмещенным (совместным) адресным пространством:

![](../../ПМ/pictures/lecture20/pic5.png)

При выделенном адресном пространстве можно разрабатывать систему ввода-вывода отдельно от памяти. В случае совместного этого не получится потому, что систему ввода-вывода и память должны удовлетворять одним и тем же требованиям по связи (т.е. передачи информации).

К выделенным адресным пространствам относятся:
- Отдельная шина для системы ввода-вывода подключена к центральному процессору.
Плюсы: отдельная система ввода-вывода (для нее может быть соблюдена своя специфика, например меньшие скорости, определенный интерфейс работы, который больше подходит под данные системы)
Минусы: много точек подключения, меньшая надежность, большие габариты и т.д.

![](../../ПМ/pictures/lecture20/pic1.png)

- Системы вводы-вывода имеют отдельную шину управляющия, но шины адреса и данных совпадают с таковыми у памяти. (например x86)
Плюсы: специализация под систему ввода-вывода (т.к. управление осуществляется по другой линии), остаются отдельные инструкции для работы с вводом-выводом.

![](../../ПМ/pictures/lecture20/pic2.png)

Совместнное адресное пространство:
- Единая шина для системы ввода-вывода и основной памяти. (например RiscV)
Плюсы: В случае совместного мы имеем гибкий размер системы ввода-вывода (то есть мы можем уменьшить количество памяти и увеличить количество систем ввода-вывода или наоборот).
Минусы: програмисту сложнее разобраться в коде на Ассемблере. 

![](../../ПМ/pictures/lecture20/pic3.png)

Пример совместного адресного пространства с дешифратором адреса:

![](../../ПМ/pictures/lecture20/pic6.png)

## Структура периферийного устройства

Все периферийные устройства можно свести к трем категориям:
-    Для общения с пользователем (принтеры, мониторы и др.)
-    Для общения с вычислительной машиной (внешние устройства, которые отдают или получают информацию от внешнего мира через различные датчики, а также системы хранения информации)
-    Для связи с удаленными устройствами (передача информации на большие расстояния)

Обобщенно любое периферийное устройство можно представить в виде:

![](../../ПМ/pictures/lecture20/pic7.png)

Периферийное устройство как-то взаимодействует с внешней средой. (Например датчик температуры. На преобразователь приходит температура, каким-то образом преобразуется и отправляется в буферную память в виде нолики и единички, которые характеризуют среду.)
Буферная память и логика управления связана с модулями ввода-вывода условными сигналами (условные так как для связи с модулями ввода-вывода используется 'малый' интерфейс). 
Модуль ввода-вывода по данному интерфейсу генерирует различные сигналы управления для переферийного устройства, 'говоря' что нужно делать, и при этом собирает сигналы состояния, чтобы понимать в каком состоянии находится устройство (может быть у него какие-то проблемы или ошибки,  закончило ли оно преобразование информации (например можно узнать храниться ли что-то в буферной памяти и  можно ли это забирать)).

## Модули ввода-вывода

Основные функции модулей ввода-вывода:
- Локализация данных (выделение некоторого адресного пространства внутри которого процессор может через модуль ввода-вывода управлять периферийными устройствами).
- Управление и синхронизация (модуль ввода-вывода с одной стороны подключен 'большим' интерфейсом к высокоскоростной шине, к которой также подлючены память и процессор, а с другой стороны 'малым' интерфейсом к медленным устройствам (к переферии), у которых могут быть специфические сигналы управления и синхронизации).
- Обмен информацией 
    - Распознование команд
    - Пересылка данных (от переферии в процессор либо в память и обратно)
    - Извещение о состоянии (извещение процессора о состоянии переферийных устройств)
    - Буферизация данных
- Обнаружение ошибок (и извещение об этом процессора)

К одному модулю ввода-вывода может быть подключено много переферийных устройств, может быть много самих модулей ввода-вывода. В таком случае старшая часть адреса, которую выставляет процессор, указывает на конкретный модуль ввода-вывода, следующие несколько бит информации указывают на конкретное переферийное устройство, внутри этого модуля ввода-вывода, а последние биты указывают на конкретный регистр конкретного устройства.

## Структура модуля ввода-вывода

![](../../ПМ/pictures/lecture20/pic8.png)

Модуль ввода-вывода -- это прослойка между шиной и периферийными устройствами, у которой с одной стороны реализован контроллер 'большого' интерфейса, с другой стороны контроллеры 'малых' интерфейсов, а в середине некая логика управления, с помощью которой процессор может обмениваться информацией между интерфейсами.

## Методы управления вводом-выводом

1. Ввод-вывод с опросом
Процессор хочет получить данные от периферийного устройства.

![](../../ПМ/pictures/lecture20/pic9.png)

Плюсы: простота
Минусы: процессор постоянно занимает шину; процессор не делает ничего полезного, он занят ожиданием устройства ввода, которое может генерировать информацию миллионы тактов процессора.

2. Ввод-вывод с прерываниями

![](../../ПМ/pictures/lecture20/pic10.png)

Метод состоит из двух частей:
- Инициализация прерывания (сообщить модулю ввода-вывода, что мы ждем информацию от какого-то периферийного усторойства, после чего разрешаем прерывания от этого модуля ввода-вывода)
- Обработка прерывания (процесс просыпается и начинает читать из регистра состояний модули ввода-вывода)
Плюсы: процессор не ждет периферия сгенерирует новую информацию
Минусы: процессору приходится перекидывать информацию в основную память через себя

3. Прямой доступ к памяти (ПДП или Direct Memory Access -- DMA) 
Контроллер прямого доступа к памяти -- это устройство, которое берет на себя задачу переброски информации из периферийных устройств в основную память либо наоборот из основной памяти в периферийное устройство в обход процессора.

![](../../ПМ/pictures/lecture20/pic11.png)

Плюсы: процессор не занимается пересылкой данных.
Минусы: сложность реализации в высокопроизводительных системах с виртуальной и кэш памятью.

Получение доступа к шине КПДП:
1. Периферийное устойство по специальной линии 'дергает' контроллер прямого доступа к памяти, что нужно передать данные в основную память. 
2. КПДП формирует сигнал Запрос ПДП, который отправляется в центральный процессор. 
3. ЦП видит запрос прямого доступа к памяти, отключается от системной шины и формирует сигнал Подтверждения ПДП
4. КПДП выполняет пересылку данных.  

Либо из центрального процессора либо из периферийного устройства (в зависимости от конфигурации системы) КПДП получит адрес, с которого начнется запись в основную память (в случае переброски информации из переферийных устройств в основную память).

Передача данных из периферийного устройства в основную память:
1. КПДП запрашивает данные у периферийного устройства;
2. Периферийное устройство передает информацию в регистр данных;
3. КПДП выставляет адрес основной памяти;
4. КПДП передает информацию из регистра данных в основную память;
5. Уменьшается значение счетчика данных;
6. Увеличивается адрес;
7. Пока не закончился счетчик к пункту 1.

В одном устройстве может быть несколько DMA, если есть несколько шин.
DMA могут работать в разных режимах (режимы отличаются тем, насколько долго захватывают шину, то есть останавливают передачу информации между другими блоками системы):
- Взрывной режим (Burst mod) -- контроллер захватывает шину пока не закончит свои дела;
- Прозрачный режим -- контроллер осуществляет пересылку информации только тогда, еогда никто друго не занимает шину
- Делать по одно посылке за раз и отпускать шину на арбитраж 

## Конфигурации ПДП(DMA)

![](../../ПМ/pictures/lecture20/pic12.png)

1. Подключен к шине как устройство;
2. Выполняет роль модуля ввода-вывода для подключенного к нему набора периферийных устройств;
3. КПДП подключается с одной стороны по выделенной шине к периферийным устройствам, а с другой к системной шине.

## Канальная система ввода-вывода
Канальная система ввода-вывода -- это не просто прямой доступ к памяти, в ней есть специализированный процессор, который используется для того, чтобы связываться с периферийными устройствами. 

![](../../ПМ/pictures/lecture20/pic13.png)

Канал(процессор) ввода-вывода -- это контроллер прямого доступа к памяти, выполненный в виде специфлизированного процессора, которому можно давать сложные запросы и эти запросы будут обрабатываться программно.
Канал ввода-вывода имеет свою локальную память.
Процессор ввода-вывода обращается за своими програмками, которые осуществляют ввод-вывод в основную память.
Каналы и процессоры ввода-вывода используются для подключения большого количества переферийных устройств. Благодаря им центральный процессор более эффективно тратит свое время.

## RAID
RAID (Redundant Array of Independent Disks) -- избыточный массив независимых дисков

Это объединение нескольких винчестеров, так чтобы повысить надежность хранения информации. Существуют разные способы объединения винчестеров в группу.

Классификация Паттерсона и Хеннесси:

![](../../ПМ/pictures/lecture20/pic14.png)

- RAID 0: не повышает надежность, объединяет диски с целью более быстрого доступа к ним;
- RAID 1: информация клонируется на другие диски 
- RAID 2: создается избыточность, для того чтобы можно было восстановить данные
- RAID 3: складываются по модулю 2 новое значение на одном из дисков и не изменившиеся значения на остальных трех дисках и записываются на избыточный диск. Получившееся значение называется битом четности (битом паритета).
- RAID 4: складываются по модулю 2 бит четности, новое и старое значения элемента на одном из дисков и записываются на избыточный диск. Получается новый бит четности.

![](../../ПМ/pictures/lecture20/pic15.png)

- RAID 5: биты четности раскиданы по всем дискам, что позволяет добавлять новые значения параллельно.

![](../../ПМ/pictures/lecture20/pic16.png)

- RAID 6: RAID 5, у которого вдвое увеличено количество избыточных контрольных дисков, то есть 2 диска, в которых хранятся паритеты, что повышает надежность

## JTAG (Join Test Action Group)
JTAG -- это четырехпроводной интерфейс, с помощью которого можно проверить правильно ли работает устройство. Его часто импользуют для отладки процессорной системы.

![](../../ПМ/pictures/lecture20/pic17.png)

TMS -- управление
TDI и TDO -- входной и выходной сигналы
TCK -- сигнал тактирования

![](../../ПМ/pictures/lecture20/pic18.png)

Между каждой ножкой и ядром помещаем ячейку памяти и соединяем эти ячейки как сдвиговый регистр. Таким образом сканирующая цепочка проходит по всем ножкам всех микросхем, подключенных к этой системе.

Рассмотрим ячейку памяти:

![](../../ПМ/pictures/lecture20/pic19.png)

Input Mux и Output Mux -- мультиплексоры
Data_In и Data_Out -- ножка, котрую 'разрубаем'
Scan In и Scan Out -- вход и выход сканирующей цепочки
Shift Register -- один из триггеров сдвигового регистра (прикидываемся значениями с ножки)

FSM (Finit State Machine) -- конечный автомат (автомат состояний)

Сигналами ShiftDR, Mode и др. управляют сигналы TMS и TCK. Они управляют не напрямую, а подключены к автомату состояний, который работает таким образом:

![](../../ПМ/pictures/lecture20/pic20.png)

где DR -- Data Register, IR -- Instruction Register
Автомат состояний используется для того, чтобы по-байтово битик за битиком загрузить в регистр нужную информацию.

Структура JTAG:

![](../../ПМ/pictures/lecture20/pic21.png)

TAP Controller устроен как автомат состояний. Он формирует сигналы для JTAG.

## Основные материалы лекции

1. [Ссылка](https://www.youtube.com/watch?v=XtoTG6qht3A&list=PL0def37HEo5KHPjwK7A5bd4RJGg4djPVf&index=21) на видеозапись лекции 2021 года.
2. [Ссылка](https://www.youtube.com/watch?v=R-a4zkZbPVo&list=PL0def37HEo5KMH7gONw_JnczvQJBv1EZL&index=20) на видеозапись лекции 2020 года.


## Дополнительные материалы к лекции

