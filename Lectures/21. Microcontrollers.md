# Лекция 21. Микроконтроллеры

## СОДЕРЖАНИЕ
* [Микроконтроллеры на примере PIC](#Микроконтроллеры-на-примере-PIC)
* [Микроконтроллеры на примере ARM](#Микроконтроллеры-на-примере-ARM)
    * [ARM7](#ARM7) 
* [Основные материалы лекции](#Основные-материалы-лекции)
* [Дополнительные материалы к лекции](#Дополнительные-материалы-к-лекции)

> *Микроконтроллер* — это устройство, которое объединяет в себе процессор и ряд переферийных устройств и занимается управлением. 

Электронные устройства можно условно разделить на несколько категорий:
1. Различные встраиваемые системы (которые куда-то встраиваются; например, встроенные в микроволновку, холодильник или телевизор)
2. Системы общего назначения (к ним плюс-минус можно отнести системы вроде современных телефонов)

В 70-х годах компанией Texas Instruments произведен первый патент на тему микроконтроллеров: а именно "Организация микро-ЭВМ на одной микросхеме", потому что фактически контоллер является микро-ЭВМ (системой, которая объединяет процессор, переферийные модули, память команд, память данных).

Контроллеров выпускается на порядок больше, чем процессоров общего назначения.
Микроконтроллеры используются везде (в игрушках, микроволновках, клавитурах, мышках и т.д.)

Контроллеры бывают различной разрядности.
- 8-битные. Они используются для решения простых задач (например, для сравнения каких-то параметров);
- 16-битные. Они используются для более сложных задач, чем 8-битные, где нужна большая точность (например, для управления каким-то двигателем);
- 32-битные. контроллеры выполяют какие-либо вычисления: решают алгоритмы, проводят анализ сигналов.

Чтобы проверить подходит ли данный контроллер для устройства можно купить его и самому проверить, а можно купить отладочный комплект (starter kit или учебный комплект).

## Микроконтроллеры на примере PIC

Существуют различные семейства микроконтроллеров PIC. Они отличаются специализацией под определенные устройства и задачи.

Например в контроллерах семейства PIC16F19197 предусмотренно управление LCD-дисплеем.

Рассмотрим семейство PIC16F18446 (используется для подключения сенсоров, имеет низкое потребление энергии, маленький форм-фактор). Скорее всего контроллеры данного семейства устанавливаются в маленькие устройства (может быть с батарейным питанием), которые получают значения с датчиков.

Помимо процессорного ядра на микросхеме находятся различные переферийные устройства.
Например, 12-битные аналого-цифровые преобразователи (для преобразования непрерывного во времени аналогового сигнала, в котором информация кодируется в виде уровня напряжения, в цифровой сигнал, который кодируется ноликами и единичками), компораторы (сравнивают аналоговые сигналы друг с другом), конфигурируемые логические ячейки (CLC или Configurable Logic Cell), флеш память программ, основная память, EEPROM (электрически перезаписываемая программируемая память), PWM (Pulse-width modulation или широтно-импульсная модуляция), Waveform generator (генерирует сигналы), цифро-аналоговый преобразователь (ЦАП или DAG) и другие.

Микроконтроллеры есть в устройствах, которые производятся серийно, поэтому страются сделать так, чтобы контроллер умел выполнять свои задачи и каждый его элемент стоил минимальную цену.

Микроконтроллеры внутри рассматриваемого семейства отличаются размером памяти, количеством ножек, аналогово-цифровых преобразователей, максисальной аналогово-цифровой разрешающей способностью.

Рассмотрим контроллер PIC16F18313. В документации можно узнать, что это за контроллер и что он умеет. 
Например это RISC процессор, поддерживающий 48 инструкций он поддерживает C-компилятор у него входная тактовая частота 32 MHz, минимальный тактовый цикл 125 ns (величина критического пути), система прерываний, 16-уровневый стек для вызова подпрограмм, четыре 8-битых таймера, Watchdog Timer (когда таймер досчитывает до конца, он сбрасывает микроконтроллер, то есть перезапускает его. Он нужен для того, чтобы избежать зависаний во время работы) и т.д. 

Данный микроконтроллер имеет 3 конфигурации: с 8-ю, 14-ю и 16-ю ножкам.  
<div align="center">

![](../../ПМ/pictures/lecture21/pic1.png)  
*Рис. 1. Микроконтроллер PIC16F18313 с 8-ю ножками.*
</div>

Для каждой кофигурации имеется табличка, в которой расписанно, для чего может использоваться каждый конкретный вывод.  
Пример для контроллера PIC16F18313 с 8-ю ножками:
<div align="center">

![](../../ПМ/pictures/lecture21/pic2.png)  
*Рис. 2. Таблица подключения переферийных усторойств для микроконтроллера PIC16F18313.*
</div>

<div align="center">

![](../../ПМ/pictures/lecture21/pic3.png)  
*Рис. 3. Схема микроконтроллера PIC16F18313.*
</div>  
Например, у данного контроллера мы видим CPU (центральный процессор); Timing Generator, который формирует сигналы тактирования. Микроконтроллер выполнен по Гарвардской архитектуре, то есть у него разделена память команд и память данных. Порты ввода-вывода, переферийные устройства и память данных подключены к CPU общей шиной данных.

<div align="center">

![](../../ПМ/pictures/lecture21/pic4.png)  
*Рис. 4. Рекомендуемое минимальное подключение микроконтроллера PIC16F18313.*
</div>

<div align="center">

![](../../ПМ/pictures/lecture21/pic5.png)  
*Рис. 5. Тракт данных ядра (микроархитектура).*
</div>

Управление системой происходит по обращению к конкретным адресам:  
<div align="center">

![](../../ПМ/pictures/lecture21/pic6.png)  
*Рис. 6. Адреса регистров.*
</div> 

<div align="center">

![](../../ПМ/pictures/lecture21/pic7.png)  
*Рис. 7. Форматы кодирования для микроконтроллера PIC16F18313.*
</div>

Пример программирование 32-битного контроллера PIC. Для этого, после подключения питания (Bypass capacitors), подаем тактирование (SG636PCE 40MHz oscillator), подключаем микроконтроллер к программатору (RJ11 ICD3 Jack).
<div align="center">

![](../../ПМ/pictures/lecture21/pic8.png)  
*Рис. 8. Схема подключения PIC32.*
</div>  
<div align="center">

Программатор одной стороной подключается к микроконтроллеру, а другой к компьютеру.
![](../../ПМ/pictures/lecture21/pic9.png)  
*Рис. 9. Программатор.*
</div>  
<div align="center">

![](../../ПМ/pictures/lecture21/pic10.png)  
*Рис. 10. Пример кода, для отладки микроконтроллера.*
</div>  

## Микроконтроллеры на примере ARM

Посмотрим 32-битный ARM микроконтроллер STM32H723VE.  
Видим, что у данного контроллера ядро Cortex-M7, он работает на частоте 550MHz, имеет 1 MB флэш-памяти, 564 KB оперативной памяти.
<div align="center">

![](../../ПМ/pictures/lecture21/pic11.png)  
*Рис. 11. Характеристики микроконтроллера STM32H723VE.*
</div>  

Ядро умеет работать с числами с плавающей запятой, контроллер может работать с графикой, имеет режим low power (низкого энергопотребления), аналоговую периферию, 4 DMA (прямой доступ к памяти), 24 таймера, термометр, генератор случайных чисел

<div align="center">

![](../../ПМ/pictures/lecture21/pic12.png)  
*Рис. 12. Схема микроконтроллера STM32H723VE.*
</div>  
В верхнем левом углу видим ядро, у которого отдельные кэш данных и кэш инструкции. Из него выходят наружу JTAG и ETM. К ядру подключены 2 блока памяти данных, память инструкций. У микроконтроллера много различных шин, работающих на разных скоростях, что необходимо для увеличения эффективности питания и работы. Например, периферия работает на более низких скоростях, а значит нет необходимости делать лишние тактирования.

Пример программы для микроконтроллера stm32f10x на языке C. Данная программа для мигания светодиодом, подключенным к 5 разряду порта B.
```C
#include "stm32f10x.h"  //библиотека, созданная производителем микроконтроллеров 

int main() {
    int i = 0;
    RCC->APB2ENR |= RCC_APB2ENR_IOPBEN  // включили тактирование порта B
    GPIOB->CRL   &= ~GPIO_CRL_CNFS;     // сконфигурировали порт, как выходной
    GPIOB->CRL   |= GPIO_CRL_MODES_0;   // задали скорость переключения порта
    
    while(1){
        i = 5000;
        while(i--);                     // уменьшает i до нуля
        GPIOB->BSRR = GPIO_BSRR_BS5;    // установить 5 разряд порта B в единицу
        i = 5000;
        while(i--);
        GPIOB->BSRR = GPIO_BSRR_BR5;    // установить 5 разряд порта B в ноль
    }
}
```  

<div align="center">

![](../../ПМ/pictures/lecture21/pic13.png)  
*Рис. 13. Структурная организация ARM7.*
</div>  

<div align="center">

![](../../ПМ/pictures/lecture21/pic14.png)  
*Рис. 14. Структурная организация ARM9.*
</div>  

<div align="center">

![](../../ПМ/pictures/lecture21/pic15.png)  
*Рис. 15. Структурная организация Cortex-A9.*
</div>  
Переименование регистров нужно для суперскалярности, устранения конфликтов read-after-write, write-after-write. 

Используется два ядра на кристалле, одно менее, а другое более производительное. Менее производительное потребляет меньше энергии и используется в определенных режимах, в которых не нужна высокая производительность. Переключения между ядрами позволяет балансировать между затратами на энергию и, собственно, производительностью
<div align="center">

![](../../ПМ/pictures/lecture21/pic16.png)  
*Рис. 16. Cortex-A7 и Cortex-A15.*
</div>  

## Основные материалы лекции

1. [Ссылка](https://www.youtube.com/watch?v=Z0ohQdYn2VU&list=PL0def37HEo5KHPjwK7A5bd4RJGg4djPVf&index=21) на видеозапись лекции.


## Дополнительные материалы к лекции

1. [Ссылка](https://www.microchip.com/en-us/products/microcontrollers-and-microprocessors/8-bit-mcus/pic-mcus) на сайт производителя микропроцессоров PIC.
2.  [Ссылка](https://ww1.microchip.com/downloads/aemDocuments/documents/MCU08/ProductDocuments/DataSheets/40001799F.pdf) на документацию микропроцессора PIC16F18313. 
3.  [Ссылка](https://www.st.com/en/microcontrollers-microprocessors/stm32h723ve.html) на рассматриваемый ARM микроконтроллер. 
4.  [Ссылка](https://onedrive.live.com/?authkey=%21AIXUSz0MyutL6hs&cid=1FF28DEC684C2C56&id=1FF28DEC684C2C56%2181801&parId=1FF28DEC684C2C56%2181696&o=OneUp) на статью, в которой описана сборка однотактного процессора с архитектурой PIC.

