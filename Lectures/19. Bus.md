# Лекция 19. Шины. 

## Содержание:
* [Системы соединений](#системы-соединений)
* [Терминология](#потоково-безопасное-программирование)
* [Типы шин](#типы-шин)
* [Иерархия шин](#иерархия-шин)
* [Арбитраж и схемы арбитража](#арбитраж-и-схемы-арбитража)
* [Повышение эффективности шин](#повышение-эффективности-шин)

## Системы соединений

**Система** — это объединение нескольких элементов для решения общей задачи.
Система соединений должна обеспечивать обмен информации между:
* процессором и памятью;
* процессором и модулями ввода\вывода;
* памятью и модулями ввода\вывода.

Как же воедино соединить элементы системы?

Нужно использовать несколько шин, каждая из которых соединяется с разными элементами системы. Например, это необходимо потому что ЦП обменивается информацией с памятью в гигабитах в секунду, а с клавиатурой в байтах в секунду, поэтому неразумно помещать их на одну шину.

![](https://sun9-55.userapi.com/impg/JvItlVU33ossB3oLVzVzI2SMi9y5x1PNBTdR2g/5ibWDs4M-DA.jpg?size=352x206&quality=95&sign=e97b5f08e95809732f62f580723994ae&type=album)

*Рис. 1. Идеальный вариант системы соединений.*

### Интерфейс

Интерфейс — это совокупность механических, электрических (аппаратных) и программных средств, с помощью которых компоненты системы объединяются для решения задачи обмена информации.
Существуют три категории интерфейсов:
* машинные (решают задачу соединения процессора с другими устройствами);
* системно-модульные (унифицируют сопряжение модулей, предназначенных для работы в системе, что и определяет их особенности);
* системно-приборные (осуществляют объединение в систему модулей, которые могут работать автономно и для которых характерны широкие функциональные возможности).

### Шина

**Шина** с это группа сигнальных линий, предназначенных для выполнения определенной функции в программно-управляемом процессе передачи данных.
Чтобы охарактеризовать шину, нужно описать:
* совокупность сигнальных линий;
* физические, механические и электрические шины;
* используемые сигналы арбитража, состояния, управления, и синхронизации;
* правила взаимодействия подключённых к шине устройств (протокол шины).

![](https://sun9-71.userapi.com/impg/jj7XOMN8zpQFNq5arJWnniv5ek3XJa2SyJpvdg/4k1A9DjI8C8.jpg?size=603x272&quality=95&sign=fced3720ddc651ccdf5986dc015adec0&type=album)

*Рис. 2. Абстрактное представление модели шины.*

## Терминология

Операции на шине ("bus") называются транзакциями, существует:
* транзакция чтения (ввода);
* транзакция записи (вывода).

Одна транзакция — цикл шины (может занимать несколько тактовых импульсов).
Когда два устройства обмениваются информацией на шине, одно из них должно инициировать обмен и управлять им.
Устройство, которое инициирует обмен, называется "Bus master" [main] — любое устройство, способное взять на себя владение шиной и управлять пересылкой данных.
"Bus slave" [secondary] (ведомое устройство) — устройство не способное владеть шиной и управлять ей.

В любой момент времени на шине может управлять только одно ведущее устройство. Шиной предусматривается процедура допуска управления только одного из претендентов, это называет **арбитраж**.

### Обмен информации

Существуют три основных обмена информацией:
* Обмен по инициативе процессора 
Микропроцессор формирует запрос для внешнего устройства, затем внешнее устройство сообщает "Подтверждение" на обмен информацией микропроцессору и происходит обмен информацией.

![](https://sun9-62.userapi.com/impg/6l9M8Dy8RywFUNRoFdJVEk2e5MsxZT95B-TfMQ/PhHN4R8KQ9g.jpg?size=354x100&quality=95&sign=b9a013528aceac8f559051a04506d7d7&type=album)

*Рис. 3. Пример обмена по инициативе процессора.*

* Обмен по инициативе внешнего устройства.
* Внешнее устройство формирует запрос для микропроцессора, затем микропроцессор сообщает "Подтверждение" на обмен информацией внешнему устройству и происходит обмен информацией. При этом во время обмена ведущее устройство (микропроцессор) управляет всеми процессами.

![](https://sun9-68.userapi.com/impg/TbRtwklidFW07wQAguATL9Gdot15QnQ-k54hUg/n5IMh7sAuE8.jpg?size=350x102&quality=95&sign=37ff9f04e44234dbf0f8f22c6e81820a&type=album)

*Рис. 4. Пример обмена по инициативе внешнего устройства.*

* Обмен между внешними устройствами по инициативе одного из них.

![](https://sun9-68.userapi.com/impg/TbRtwklidFW07wQAguATL9Gdot15QnQ-k54hUg/n5IMh7sAuE8.jpg?size=350x102&quality=95&sign=37ff9f04e44234dbf0f8f22c6e81820a&type=album)

*Рис. 5. Пример обмена внешними устройствами по инициативе одного из них.*

## Типы шин

Шины делятся по целевому назначению:
* шины "процессор-память" (которые специализированы для передачи информацией между процессором и памятью);

![](https://sun9-3.userapi.com/impg/JhCrJqcwKKSrWiYBKXU1rfq3qmDPRgcHgSOvGg/S0_w48dtOeY.jpg?size=664x253&quality=95&sign=13d69525f2b6f344ccc0be415d72cc81&type=album)

*Рис. 6. Пример шины "процессор-память".*

* шины ввода-вывода (их особенность заключается в том, что они хорошо стандартизированы и более медленные, потому что ввод-вывод генерирует информацию медленно);
* системные шины (нужны для объединения элементов систем).

Системная шина условно состоит из трёх шин: шины данных, адреса и управления.
   * Шина адреса — это шина, по которой выставляются адреса устройства, к которому мы хотим обратиться. Ширина шины данных может быть 32, 64, 128 бит (ширина обычно называется "словом").
   * Шина данных — это шина, по которой передаются данные (адреса ячеек памяти, портов ввода\вывода, регистры процессора и так далее. Может быть выбран диапазон адресов "broadcast" и "broadcall") — 36-40 битов.
   * Шина управления (Control Bus)
   Control Bus (шина управления) — шина для передачи управляющей информации и информации о состоянии участвующих в транзакции устройств. 

![](https://sun9-65.userapi.com/impg/tgcBZzC5ut2Ftkwi8Zq1P_3fVK8HNRulZZrcgA/zgHnoV0iTDM.jpg?size=1303x292&quality=95&sign=4368a9f2dd228dbf40cb1d9b724cbaea&type=album)

*Рис. 7. Модель системной шины.*

*Какие сигналы могут быть внутри шины управления*:
* 1. Сигналы управления транзакциями (среднее значение сигнальных линий: 2-8) делятся на:
  * указан тип транзакции (чтение\запись);
  * указано количество байт и номер байт, если пересылается часть слова;
  * указан тип адреса выданный на шину.
* 2. Информация состояния (статус) — для передачи кодов ошибок и состояний (среднее значение сигнальных линий: 1-4).
* 3. Линии арбитража — выбор управляющего шиной устройства (среднее значение сигнальных линий: 3-11).
* 4. Линии прерывания (среднее значение сигнальных линий: 1-2).
* 5. Последовательные локальные сети (среднее значение сигнальных линий: 1-4).
* 6. Линии позиционного кода (среднее значение сигнальных линий: 4-5).
* 7. Тактирование и синхронизация (среднее значение сигнальных линий: 2-6).
* 8. Линии питания и заземления.


В некоторых системах применяют мультиплексированную шину адреса/данных для экономии количества линий, из-за чего повышается скорость передачи информации.

![](https://sun9-80.userapi.com/impg/BWo9_rHk4iwWHyJ0xucSTI_CB_DIzK3IBYX2EQ/mHDq7mrcK3M.jpg?size=704x264&quality=95&sign=e00cd7e221ae8a568c5ecf5ba59bc12f&type=album)

*Рис. 8. Мультиплексируемая шина адреса/данных.*

## Иерархия шин

Существует три основных уровня иерархии шин:
* Одноуровневая иерархия:
В этом уровне иерархии медленные устройства занимают системную шину и она не доступна для центрального процесса и памяти.

![](https://sun9-75.userapi.com/impg/xJlTK-o94bKgeu_iyP8LXelu7801zpZl0Zeriw/td5nIfXhKP4.jpg?size=356x215&quality=95&sign=87e6793bafb34b3392b01a15682a0fca&type=album)

*Рис. 9. Одноуровневая иерархия.*
* Двухуровневая иерархия:
В данном типе есть адаптеры, к которым подключаются шины. На системной шине "висят" высокопроизводительные элементы системы, а через адаптеры сгруппированы и подключены более медленные внешние устройства. Главным минусом является то, что если устройствам модуля ввода\вывода нужно обменяться информацией друг с другом — они будут обмениваться через системную шину, а значит будут её занимать.

![](https://sun9-40.userapi.com/impg/YTqBIGqZcP43Xuf-oBfwBHw7dWIyDEZuwnk-yw/hxwxiSHOrB4.jpg?size=431x345&quality=95&sign=69dfbe46818237f5e87f74df53b5d6f7&type=album)

*Рис. 10. Двухуровневая иерархия.*
* Многоуровневая иерархия:
В этом уровне иерархии существует системная шина для объединения высокопроизводительных элементов, к ней подключен адаптер, который в свою очередь ограничивает другую шину с подключёнными к ней другими адаптерами.
В таком случае, если устройствам модуля ввода\вывода нужно обменяться информацией друг с другом — они будут делать это в обход системной шине. Когда им надо будет выйти на системную шину они смогут сделать это на высокой скорости, потому что есть адаптер, который будет выполнять задачу буферизации.

![](https://sun9-54.userapi.com/impg/SYToVirIAbcTfnp-o3lvCxRSYqGNqYRra3oOCw/o_GZeRNY2q0.jpg?size=410x458&quality=95&sign=498963de18ac1b743d10d0abd7353b47&type=album)

*Рис. 11. Многоуровневая иерархия.*

## Арбитраж шин

### Алгоритмы арбитража

Каждому потенциальному 'ведущему' присваивается приоритет, для того чтобы дать устройствам возможно обмениваться информацией:
* **Статический приоритет** (за каждым устройством закреплён номер приоритета, чем меньше номер, тем выше приоритет. Проблема заключается в том, что одно устройство может занять шину навсегда и другие устройства не смогут общаться между собой).
* Динамический приоритет (при повторном использовании шины меняется приоритет).
Варианты смен приоритета:
   * **Простая циклическая смена приоритетов** (после каждой итерации разыгрывается приоритет и тот, у кого был самый низкий приоритет становится самым высоким).

![](https://sun9-63.userapi.com/impg/BZ-Yy2wbobg7hxOLNAB1dIWVb3oy3Evg0RMQBg/V7201hfqfnY.jpg?size=588x186&quality=95&sign=5caed935e81d8b9bcc1d490fb9afe478&type=album)

*Рис. 12. Распределение приоритетов.*
   * **Циклическая смена приоритетов с учётом последнего запроса** (Rotating Daisy Chain — RDC):
Допустим, третье устройство "выигрывает" шину, начинает передавать информацию. После "общения" устройство, которое передавало информацию получает самый низкий приоритет.
   * **Смена приоритетов по случайному закону** (RND):
Приоритеты меняются по закону псевдослучайной последовательности чисел (Псевдослучайная последовательность чисел - это последовательность, которая кажется статистически случайной, несмотря на то, что была получена в результате полностью детерминированного и повторяемого процесса).
   * **Алгоритм наиболее дальнего использования** (LRU):
Приоритет устройства, которое дольше всего не использовали, постепенно возрастает после каждого арбитража шины.
* Можно использовать **фиксированный квант времени**:
Допустим, у нас есть 10 устройств и каждому из устройств даётся момент времени, когда ему надо определиться хочет ли он общаться или нет. Этот цикл происходит до того момента, пока не найдут готового к общению на шине устройства. Однако скорость реакции на запрос шины будет меньше, чем в других реализациях.
* На основе очереди (FIFO):
Когда одно устройство заканчивает общение на шине — сразу же начинает общение устройство, которое стоит следующим в очереди. Но FIFO можно легко "забить". Например, пока обрабатываем один запрос ещё 20 других запросов пришло и буфер "забился".

### Схемы арбитража

Схемы арбитража бывают двух типов:
* Централизованный арбитраж (есть устройство, которое называется "арбитр", все устройства подключаются к нему и спрашивают кто из них получит доступ к общению) делится на две категории:
   * Параллельный;
   * Последовательный.
* Децентрализованный арбитраж ("арбитр" у каждого устройства свой).

**Централизованный параллельный арбитраж**.
В этой схеме у нас присутствуют ведущие устройства, которые могут занимать шину и могут инициировать обмен информацией. Есть центральный арбитр, решающий кто будет общаться на шине. Каждое устройство соединено с арбитром двумя сигналами — это "запрос шины" и "предоставление шины". Все устройства подключены к общей линии "Шина Занята" (ШЗ), с помощью этой линии все устройства могут видеть свободна ли шина или занята. Задача центрального арбитра заключается в определении устройства с максимальным приоритетом и предоставлении шины этому устройству.

![](https://sun9-64.userapi.com/impg/DD1eNqhJEYe0BRTYmz2C8nDgWHCdSMVVPI_xFg/yAcWETO_kuI.jpg?size=408x359&quality=95&sign=6422fb3c4a07de31435ee92e716b8bf4&type=album)

*Рис. 13. Схема централизованного параллельного арбитража.*

**Централизованный последовательный арбитраж**.
В данной реализации приоритеты фиксированы и зависят от того где конкретно подключено устройство. Есть сигнал "Шина Занята" (ШЗ), есть сигнал "запрос шины" и "предоставление шины" от центрального арбитра.

![](https://sun9-72.userapi.com/impg/QP5owvwPwPsa-XIuUnxvDDfKmsGuwCryGY74fQ/AfisiT57i-g.jpg?size=816x262&quality=95&sign=f12cc0fdaccbbe0a7500dcfc9cb295e1&type=album)

*Рис. 14. Схема централизованного последовательного арбитража.*

Для примера рассмотрим ситуацию, когда два устройства одновременно запросили общение на шине ("Ведущий n-2" и "Ведущий 0"). Центральный арбитр видит, что шина не занята и даёт сигнал первому устройству.

![](https://sun9-19.userapi.com/impg/j-YOkYshI_qcaXWfIXTK_kCNe6QWK_B9SY0i4A/Zm7Jr8OMedk.jpg?size=801x252&quality=95&sign=97d9bc67dd977f4d22f4ced6e35f320c&type=album)

*Рис. 15. Предоставление сигнала на пользование шиной устройству "Ведущий n-1".*

Первое устройство ("Ведущий n-1") получило этот сигнал, но так как ему не нужно общаться на шине — оно передаёт его следующему устройству ("Ведущий n-2")

![](https://sun9-65.userapi.com/impg/e_3mwFzdkw4j0MwkS8F6cMncQtIvolJlquSdLg/ubwgF012Nvo.jpg?size=804x256&quality=95&sign=91b6c71a8e5b5df41f18cd1acc9ff43c&type=album)

*Рис. 16. Передача сигнала устройству "Ведущий n-2".*

После этого устройство "Ведущий n-2" не распространяет этот сигнал дальше и занимает шину.

![](https://sun9-71.userapi.com/impg/kUO9LdpHXsp8IjH8xETI01THTt0adCF5dfJphg/bl60axQwdaQ.jpg?size=803x255&quality=95&sign=8024aa03fd5f48589f33da38392c634d&type=album)

*Рис. 17. Устройство "Ведущий n-2" заняло шину для общения.*

**Децентрализованный арбитраж**.
В данной реализации все устройства связаны друг с другом проводами. Когда какое-то из устройств хочет занять шину — оно видит сигналы от других устройств. Таким образом, перед тем как выставить свой запрос, устройство смотрит нет ли запросов с большим приоритетом. Если есть, то устройство не отправляет свои запросы, так как это не имеет смысла.

![](https://sun9-43.userapi.com/impg/ioJa6WKwN8FToMCNbkxKTZNIp9EPaw2QK79yPQ/Gyt39VQqC88.jpg?size=601x206&quality=95&sign=c11a83e73de78a5fb34aa2aa038d5b96&type=album)

*Рис. 18. Схема децентрализованного арбитража.*

### Протоколы шин

Протоколы шин бывают двух типов:
* синхронные (когда происходит синхроимпульс, тогда происходят и какие-то события на шине);

![](https://sun9-18.userapi.com/impg/M1D6JBS57W4CI81oZWeD1yOJKTgPkcMHhjDcsQ/c-9OGR1c2xg.jpg?size=499x193&quality=95&sign=8c81177a745e2ea81f908f01f0d3c2b4&type=album)

*Рис. 19. Схема синхронного протокола шин.*

* асинхронные (как только устройство способно отреагировать — оно сразу же реагирует).

![](https://sun9-15.userapi.com/impg/t6YPt4B0XqZ9Kbq41Z5p7ZlyvkT6YRcRptPHXw/CtJZSTytRSU.jpg?size=528x260&quality=95&sign=beb4303e88c2e02b955f771b5b33c4ca&type=album)

*Рис. 20. Схема асинхронного протокола шин.*

## Повышение эффективности шин

Методы повышения эффективности шин:
* Пакетный режим пересылки информации (передаётся не одна порция данных, а сразу несколько порций данных по нескольким адресам).

![](https://sun9-63.userapi.com/impg/to8YErCXtg2Cv0B_YRSg3Rn-4my8qP7D3CKk8w/uE5fSHOU7Bg.jpg?size=541x101&quality=95&sign=9510013c4d889dd984da140e6604069f&type=album)

*Рис. 21. Схема пакетного режима пересылки информации.*

* Конвейеризация транзакций (предназначена для высокоскоростных шин).

![](https://sun9-37.userapi.com/impg/vJk-iUgk-Ny3H0uIHHQOhq7cGaY43qrbiNWu2g/JW-D7JFTXho.jpg?size=354x111&quality=95&sign=a026a46afb0ac17eb3f4f0247f742642&type=album)

*Рис. 22. Схема конвейеризации транзакций.*

Можно менять данные на выходе А ещё до того момента времени, когда эти данные окончательно воспринялись устройством B, главное выдерживать нужные временные "тайминги"

* Протокол с расщеплением транзакций (мы не ждём ответ на конкретную транзакцию, а выдаём его когда у нас есть возможность).

![](https://sun9-30.userapi.com/impg/A1fALHdOADkRkCiuWbfdrLgETgosTuyundUnMw/2m0eWfBHVVA.jpg?size=524x92&quality=95&sign=e5fd62e1a3da1b96fd8884c36c853ef1&type=album)

*Рис. 23. Схема протокола с расщеплением транзакций.*

Ответ на транзакцию приходит с запросом не сразу. То есть мы не ждём ответ на конкретную транзакцию, и выдаём ответ когда есть возможность.
Например, на рисунке 21 для *адреса 1* у нас была возможность получить ответ сразу, так же и с *адресами 3 и 4*, а вот для *адреса 2* возможность получить ответ появилась только получения ответов для *адреса 3 и 4*. Таким образом, за счёт протокола с расщеплением транзакций всё будет работать корректно.

* Арбитраж с перекрытием (очередной арбитраж происходит ещё на стадии передачи прошлой информации).

Очередной арбитраж происходит ещё на стадии передачи прошлой информации.
Допустим, "разыграли" шину и мы ей завладели, затем другое устройство сообщает, что хочет завладеть этой шиной. Вместо того чтобы он просто ждал — включается арбитр и определяет, можно ли будет этому устройству завладеть шиной или нельзя. Как только заканчивается передача, сразу же идёт переключение на другое устройство.

* Арбитраж с удержанием шины (ведущее устройство захватывает шину и начинает передавать большое количество информации, то есть передача шины происходит только при возникновении запроса)

Например, ведущее устройство захватывает шину и начинает передавать **большое количество информации**. Это устройство передаёт информацию и видит, что другие устройства не отправляют запрос на пользование шиной, тогда ведущее устройство продолжает передавать информацию. То есть когда возникнет запрос, тогда устройство сразу передаёт шину.

### Увеличение полосы пропускания

Для увеличения полосы пропускания существуют следующие способы:
* отказ от мультиплексирования шин адреса и данных;
* увеличение ширины данных;
* повышение тактовой частоты.

### Стандартизация шин

Из стандартизированных шин можно выделить две большие группы:

* Шины "большого" интерфейса (высокопроизводительные шины, связывают память, процессор, модули ввода\вывода)
   * PCI Express
   * Hyper Transport
   * QPI
 
* Шины "малого" интерфейса (служат для присоединения периферийных устройств к модулям ввода\вывода)
   * USB
   * Bluetooth
   * UART
   * CAN
   * SPI
   * I2C

### Последовательный синхронный обмен

![](https://sun9-59.userapi.com/impg/zj23LnXN820AvrR-Mi2fvw3j20zOUASF1z6Jog/3WOCna1Bl8s.jpg?size=659x310&quality=95&sign=6a3de2fe18cb9443e7c5eee48c5307d1&type=album)

*Рис. 24. Схема последовательного синхронного обмена.*

Для того чтобы организовать последовательный синхронный обмен информации, нам нужна линия, по которой мы передаём информацию и линия, по которой происходит синхронизация.

Как работает последовательный синхронный обмен:
На схеме есть генератор импульсов (ГН), который генерирует тактовый сигнал (он управляет сдвиговым регистром и передаёт сигналы на приёмник). Передатчик параллельно с этим загружает информацию в сдвиговый регистр, затем информация по одному биту перемещается в другой сдвиговый регистр. После того как вся информация передалась — приёмник просто считывает эту информацию

### Последовательный асинхронный обмен

![](https://sun9-46.userapi.com/impg/wCwN8Px0PAqFN4G9EMNqk0yFgytnXIzxYpNhUg/zL2CLf9kvto.jpg?size=708x311&quality=95&sign=4f4d1871e098f157413f633729c38ed1&type=album)

*Рис. 25. Схема последовательного асинхронного обмена.*

Отличие от последовательного синхронного обмена заключается в том, что из-за отсутствия тактовых импульсов приёмнику и передатчику необходимо договориться про скорость, на которой будет происходить обмен. На нашей схеме генератор импульсов на приёмнике в 16 раз выше частотой чем на передатчике. Схема управления будет 16 раз считывать каждый бит, то есть если 14 раз была единица и 2 раза ноль, значит была единица.




### Основные материалы лекции
1. [Ссылка](https://www.youtube.com/watch?v=UXmY3LS_xWk&list=PL0def37HEo5KHPjwK7A5bd4RJGg4djPVf&index=23) на видеозапись лекции
2. [Ссылка](https://onedrive.live.com/view.aspx?resid=1FF28DEC684C2C56!81737&cid=1ff28dec684c2c56&authkey=!AIXUSz0MyutL6hs&CT=1698668305325&OR=ItemsView) на лекцию в формате Power Point
