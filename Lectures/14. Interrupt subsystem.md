# Лекция 14. Подсистема прерывания

### Содержание
* [Определение](#Определение)
* [Передача управления при прерывании](#Передача-управления-при-прерывании)
* [Классификация событий прерывания](#Классификация-событий-прерывания)
* [Основные характеристики прерываний](#Основные-характеристики-прерываний)
* [Способы выявления прерывания](#Способы-выявления-прерывания)
* [Схемы реализации контроллера прерываний](#Схемы-реализации-контроллера-прерываний)
* [Control and Status Register Risc-V](#Control-and-Status-Register-Risc-V)


### Определение

**Прерывание** - событие, на которое реагирует процессор. 

_Пример_: Перемещение курсора по экрану. Если бы не было прерываний, то процессор был бы вынужден постоянно обращаться к курсору с целью узнать: изменилось ли его положение или нет. А это очень ресурсоёмко. 

### Передача управления при прерывании ###
Допустим, во время выполнения программы произошло событие прерывания. Процессор останавливает её выполнение на i-инструкции и начинает выполнять программу обработки прерывания. Завершив её, процессор возобновляет основную программу с i+1-инструкции, причём прерывание на результат выполнения не влияет.

<div align="center">
    
![](https://sun9-2.userapi.com/impg/GQiv1r_Ut17w1xVBPWhzMxbwfUWhILqp-tyTKw/zpj5WO0oYlI.jpg?size=453x241&quality=95&sign=7529a0a0e12f45f6b6a7c92fe34d5cac&type=album)

*Рис. 1. Схема передачи управления при прерывании.*
</div>


### Классификация событий прерывания ###
* **Прерывание** - события, которые происходят внутри аппаратуры. Это событие происходит _ассинхронно_ с фронтом тактового импульса. Например: изменение положения курсора.
    - Маскируемые - прерывания, которые процессор может игнорировать. _Например_: нажатие клавиши на клавиатуре. [Аппаратная реализация](#Маскирование-прерывания) будет продемонстрированна чуть позже.
    - Немаскируемые - прерывания, которые процессор не может игнорировать. _Например_: сигнал от датчика температуры о перегреве процессора.  
* **Исключения** - события, которые происходят внутри программы. Это событие происходит _синхронно_ с фронтом тактового импульса.
    - Ошибки. _Например_: обращение в несуществующую область памяти.
    - Ловушки. _Например_: деление на 0.
    - Отказы. _Например_: ситуации, которые никак нельзя устранить. Зачастую приводят к выключению/перезапуску процессора.

### Основные характеристики прерываний ###
* **Время реакции прерывания**, T<sub>реакции</sub>

  Это время, между запросом на прерывание и переходом к прерывающей программе (см. рис. 2) 

* **Затраты времени на переключение программ**, T<sub>загрузки</sub> и T<sub>востановления</sub>

  Это время, которое требуется программе выполнить сервисные инструкции (см. рис. 2). Например: узнать причину прерывания, сохранить данные на стек прерывания и др.

* **Эффективность прерывания**

  Это время эффективной работы программы. Т.е. отношение "полезных" (не сервисных) инструкций программы прерывания ко всем интсрукциям прерывания.

<div align="center">
    
![](https://sun9-32.userapi.com/impg/vMcgz-Eh73spCuy-Vx1jUEMw4uCaby6-1a54FA/_xp9ZL30BmY.jpg?size=580x202&quality=95&sign=dae8f9375c7909fa13786ccd3bc31af4&type=album)

*Рис. 2. Характеристики прерывания.*
</div>

* **Глубина прерывания**

    Это кол-во прерываний, которые могут произойти во время обработки прерывания (см. рис. 3). Например: если процессор, находясь внутри прерывания, не способен прерваться на другое, то говорят что глубина прерывания n=1. Также программы могут неограниченно прерывать друг друга, в таком случаем есть ограничение по памяти.


<div align="center">
    
![](https://sun9-77.userapi.com/impg/-GTsKOxTOTFas97itwiPCkMfpiFxy_YXJS3wTw/MMf09w31ad0.jpg?size=545x275&quality=95&sign=bacd790f453e2db6c9176270047f76c6&type=album)

*Рис. 3. Глубина прерываний.*
</div>

### Допустимые моменты прерывания программы ###

* **Метод помеченного оператора**

    Внутри какой-нибудь инструкции добавляется бит, отвечающий за прерывание. Допустим, если этот бит равен 1 и есть сигнал на прерывание, то процессор запустит обработчик прерывания.

* **Покоманднный метод**

    Этот метод относиться к _многотактным архитектурам_. Процессор начинает реагировать на сигнал прерывания, только после завершения инструкции. 

* **Метод быстрого реагирования**

    Этот метод позволяет реагировать на прерывание на любом такте.

  #### Маскирование прерывания ####
  **Маска прерывания** - это регистр, отвечающий за разрешение на прерывани (см. рис. 4). Это маска побитово перемножается с запросами на прерывание других устройств/модулей и тд. Если в результате перемножения получилась хотя бы одна 1, то формируется сигнал _interrupt_, который подаётся на блок управления процессора. 


<div align="center">
    
![]( https://sun9-74.userapi.com/impg/ScRTZGH65FMeQEivFUOssR2d2HBzIeLhcx-u2g/r7IEgx1blWM.jpg?size=470x323&quality=95&sign=efb81c5d2e2ddca8f07a0c67c3025cfe&type=album)

*Рис. 4. Аппаратная реализация маскирования прерывания.*
</div>

### Способы выявления прерывания

* **Обзорная система прерывания**

    Каждый запрос на прерывание запускает одну и ту же подпрограмму, которая определяет кто отправил запрос, а затем запускает конкретную программу обработчика прерывания. Работает такая система сравнительно дольше, но реализация её проще.

* **Векторная система прерывания**

    В векторной системе есть участок памяти - _таблица векторов прерывания_. В таблице лежат **вектора прерывания** - адрес начала подпрограммы обработчика прерывания. После обращения к таблице будет запущена нужная подпрограмма. Работает такая система быстрее, но реализовать её сложнее.



### Схемы реализации контроллера прерываний
[**Контроллер прерывания**](#Контроллер-прерывания) - устройство, которое отвечает за передачу сигнала прерывания процессору и формирование кода причины прерывания. 

* **Цепочечная схема**

    От процессора приходит сигнал подтверждения (ПДТ), который приходит только тогда, когда процессора готов обработать какое-то прерывание (См. рис. 5.). Это сигнол приходит на какое-то устройство, которое, в случае необходимости, выдаёт сигнал на прерывание и вектор прерывания процессору. Если же в прерывании от первого устройства нет необходимости, то сигнал потверждения передаётся на следующее устройство и т.д. Цепочечная схема проста в реализации, но очень долгая. К тому же в этой схеме некоторые устройства имеют преоритет на другими в очерёдности обработки запроса на прерывание. Также сущесвтует вероятность, что до последних устройств никогда не дойдёт сигнал подтверждения и они не смогут прервать выполнение. 

<div align="center">
    
![]( https://sun9-9.userapi.com/impg/ECurRjLX9GgWKN5Q8TqSHi7p2xEZ3zjUQqLkDQ/X3J_UUQ3SoI.jpg?size=358x281&quality=95&sign=c585c81f6acd83da3282093fba1431d2&type=album)

*Рис. 5. Цепочечная схема.*
</div>

* **Схема с циклическим опросом**

    Каждый раз, когда на счётчик СТ приходит сигнал C (тактирование), он увеличиает своё значение (см рис. 6). Затем это значение подаётся на вход дешифратору (DC), который только на одном выходе выдаёт 1. И каждый такт выход меняется от 0 до N. Если во время обхода всех выходов появится сигнал на прерывание, то этот сигнал отправится на R-S тригер, который затем отправит interrupt сигнал процессору. А на вход C счётчика CT будет отправлен 0. В таком случае счётчик перестанет суммировать и он будет иметь значение кода номера прерывания. 
    
<div align="center">
    
![](https://sun9-23.userapi.com/impg/VaCCIXa-kjhBrWpIq202qaBFNThYb-LmEtKW4w/Rv5hs4j1JfA.jpg?size=500x327&quality=95&sign=de3ce75eaef5e81e05e4a54a5510cf90&type=album)

*Рис. 6. Циклическая схема.*
</div>
    
* **Дейзи-цепочка**
    
    Рассмотрим дейзи-цепочку (см. рисунок 7). Эта схема будет работать только тогда, когда вход "Приоритет" равен 1. Если на первый запрос пришла 1, то на соответсвующий выход y<sub>1</sub> будет подана 1, которая будет говорить о том, что именно первое устройство сделало запрос на прерывание. На выход INT также будет передана 1, которая отправится процессору для оповещения о прерывании. Т.е. на выходе y<sub>1</sub>...y<sub>n</sub> будет получена только одна 1 от запроса с наивысшим приоритетом. Дейзи-цепочка часто используется в определении наиболее приоритетного запроса.  


<div align="center">
    
![](https://sun9-55.userapi.com/impg/191tCbLsvRWn4XTQDN_ZaEygWGE9YaxFTOdJ2w/QVYvX2yJDT0.jpg?size=718x375&quality=95&sign=9e88a78f14eca5e397f4efaa9b0bde28&type=album)

*Рис. 7. Дейзи-цепочка.*
</div>

#### Контроллер прерывания
Теперь рассмотрим вцелом, как выглядит контроллер прерывания. (см. рис. 8) По каналу _ПДТ_ поступает сигнал от процессра, разрешающий прерывание. Этот сигнал поступает на регистры запроса прерывания. Затем с помощью [маски прерывания](#Маскирование-прерывания) определяются, каким устройствам разрешён запрос на прерывание. Сигналы на прерывания попадают в "_схему определения наиболее приоритетного запроса_" (_например_: дейзи-цепочка), где определяется самый приоритетный запрос.  С помощью "_формирователя номера запроса_" формируется некоторое число, отвечающее за степень приоритета запроса. В "_схеме сравнения приоритетов_" сравнивается это число с приоритетом текущего прерывания(приоритет текущего прерывания записан в регистры "_порога прерывания_"). Если число, хранимое в регистрах "_порога прерывания_" меньше, то  в "_порог прерывания_" записывается новое число, а на процессор по каналу _ЗП_ на процессор пойдёт сигнал о новом прерывании.    
    
<div align="center">
    
![](https://sun9-78.userapi.com/impg/mOhQU0GvbXsQzy07i7UmvT8LS4Vjaf9lwKm__w/8gJ67LZVPgA.jpg?size=770x427&quality=95&sign=a93df0d24e5d251b4ae437bab1a72226&type=album)

*Рис. 8. Схема контроллера прерывания.*
</div>


### Control and Status Register Risc-V
Это набор регистров, связанные с блоками процессора, с помощью которых можно управлять ими или узнавать информацию о них.  
Минимальный набор для поддержания прерывания в Risc-V нужно реализовать следующие регистры:

| Номер       | Привелегия | Имя       | Описание                                                   |
|:------------|:-----------|:----------|:-----------------------------------------------------------|
| Ox304       | MRW        | mie       | Регистр маски                                              |
| Ox305       | MRW        | mtvec     | Регистр вектора прерывания                                 |         
| Ox340       | MRW        | mscratch  | Регистр указателя на стек прерывания                       |
| Ox341       | MRW        | mepc      | Регистр адреса инструкции, на котором случилось прерывание |
| Ox342       | MRW        | mcause    | Регистр причины (кода) прерывания                          |


 Инструкции для работы с CSR: 
 
    
| Opcode    | func3 | Тип  | Инструкция          |  Описание                 | Операция                |
|:----------|:------|:-----|:--------------------|:--------------------------|:------------------------|
| 1110011   | 000   |  I   | mret                | Возврат и прерывание      | PC=merc                 |
| 1110011   | 001   |  I   | csrrw rd, csr, rs1  | Чтение/запись Csr         | rd = csr, csr=rs1       |                         
| 1110011   | 010   |  I   | csrrs rd, csr, rs1  | Чтение/установка бит Csr  | rd = csr, csr=rs1\|rs1  |
| 1110011   | 011   |  I   | csrrc rd, csr, rs1  | Чтение/очистка бит Csr    | rd=csr, csr=csr&~rs1    |

    

  


 
  

  

  
  

    

    
  






