# Лекция 19. Шины. 

## Содержание:
* [Системы соединений](#системы-соединений)
* [Терминология](#потоково-безопасное-программирование)
* [Типы шин](#типы-шин)
* [Иерархия шин](#иерархия-шин)
* [Арбитраж и схемы арбитража](#арбитраж-и-схемы-арбитража)
* [Повышение эффективности шин](#повышение-эффективности-шин)

## Системы соединений

**Система** — это объединение нескольких элементов для решения общей задачи.
Система соединений должна обеспечивать обмен информации между:
* процессором и памятью;
* процессором и модулями ввода\вывода;
* памятью и модулями ввода\вывода.

Как же воедино соединить элементы системы?

Нужно использовать несколько шин, каждая из которых соединяется с разными элементами системы. Например,это необходимо потому что ЦП обменивается информацией с памятью в гигабитах в секунду, а с клавиатурой в байтах в секунду, поэтому неразумно помещать их на одну шину.

![](https://sun9-73.userapi.com/impg/vTfyLyZPP8dW7iK_Vs_mzECNvIpSzU2DZXTWaA/hvEyz2GsTmA.jpg?size=357x269&quality=95&sign=75423df79a737f40f84bad33498ac44b&type=album)

*Рис. 1. Идеальный вариант системы соединений.*

### Интерфейс

Интерфейс — это совокупность механических,электрических (аппаратных) и программных средств, с помощью которых компоненты системы объединяются для решения задачи обмена информации.
Существуют три категории интерфейсов:
* машинные (решают задачу соединения процессора с другими устройствами);
* системно-модульные (унифицируют сопряжение модулей, предназначенных для работы в системе, что и определяет их особенности);
* системно-приборные (осуществляют объединение в систему модулей, которые могут работать автономно и для которых характерны широкие функциональные возможности).

### Шина

**Шина** с это группа сигнальных линий, предназначенных для выполнения определенной функции в программно-управляемом процессе передачи данных.
Чтобы охарактеризовать шину, нужно описать:
* совокупность сигнальных линий;
* физические, механические и электрические шины;
* используемые сигналы арбитража, состояния, управления, и синхронизации;
* правила взаимодействия подключённых к шине устройст (протокол шины).

![](https://sun9-50.userapi.com/impg/P2AN8kmBrOgbkYTqRuwLNEQ_GFFQr68LoZp0ng/hIUQEi9N5TQ.jpg?size=557x254&quality=95&sign=9881374b13e243071470215c4f15a35c&type=album)
*Рис. 2. Абстрактное представление модели шины.*

## Терминология

Операции на шине ("bus") называются транзакциями, существует:
* транзакция чтения (ввода);
* транзакция записи (вывода).

Одна транзакция — цикл шины (может занимать несколько тактовых импульсов).
Когда два устройства обмениваются информацией на шине, одно из них должно инициировать обмен и управлять им.
Устройство, которое инициирует обмен, называется "Bus master" [main] — любое устройство, способное взять на себя владение шиной и управлять пересылкой данных.
"Bus slave" [secondary] (ведомовое устройство) — устройство не способное владеть шиной и управлять ей.

В любой момент времени на шине может управлять только одно ведущее устройство. Шиной предусматривается процедура допуска управления только одного из претендентов, это называет **арбитраж**.

### Обмен информации

Существуют три основных обмена информацией:
* Обмен по инициативе процессора 
Микропроцессор формирует запрос для внешнего устройства, затем внешнее устройство сообщает "Подтверждение" на обмен информацией микропроцессору и происходит обмен информацией.
![](https://sun9-24.userapi.com/impg/9LLLN-5eMbu6yUBH4TDiNueUsWAUypSPd9TV8g/N-7e7JROFio.jpg?size=354x135&quality=95&sign=15bd7bdde35b3dcc973add416875474b&type=album)
*Рис. 3. Пример обмена по инициативе процессора.*

* Обмен по инициативе внешнего устройства.
* Внешнее устройство формирует запрос для микропроцессора, затем микропроцессор сообщает "Подтверждение" на обмен информацией внешнему устройству и происходит обмен информацией. При этом во время обмена ведущее устройство (микропроцессор) управляет всеми процессами.
![](https://sun9-61.userapi.com/impg/9hEagLAsQc0oAkhE4JZX7K2kPtKGmIiUy-nPvA/i_t3jsepG6k.jpg?size=334x94&quality=95&sign=e6c78d52df8cbe3779065a8fb6f782a6&type=album)
*Рис. 4. Пример обмена по инициативе внешнего устройства.*

* Обмен между внешними устройствами по инициативе одного из них.
![](https://sun9-10.userapi.com/impg/SM32A1vd0QwTcjBw14PhqoVLOf6XDB5d11lRcQ/vM0IKx8_1jc.jpg?size=330x243&quality=95&sign=4e8293a934e44addcbc242e3126dc40c&type=album)
*Рис. 5. Пример обмена внешними устройствами по инициативе одного из них.*

## Типы шин

Шины делятся по целевому назначению:
* шины "процессор-память" (которые специализированы для передачи информацией между процессором и памятью);
![](https://sun9-78.userapi.com/impg/9ye4JyFyXFN_s2-S0K2Pq7HYDK4M7VxJBkEwMw/-kPBYssouWY.jpg?size=655x258&quality=95&sign=e1717c34be369ee3f6d4e75e7bad2e3c&type=album)
* шины ввода-вывода (их особенность заключается в том, что они хорошо стандартизированы и более медленные, потому что ввод-вывод генерирует информацию медленно);
* системные шины (нужны для объединения элементов систем).

Системная шина условно состоит из трёх шин: шины данных, адреса и управления.
   * Шина адреса — это шина, по которой выставляется адреса устройства, к которому мы хотим обратиться. Ширина шины данных может быть 32, 64, 128 бит (ширина обычно называется "словом").
   * Шина данных — это шина, по которой передаются данные (адреса ячеек памяти, портов ввода\вывода, регистры процессора и так далее. Может быть выбран диапазон адресов "broadcast" и "broadcall") — 36-40 битов.
   * Шина управления (Control Bus)
   Control Bus (шина управления) — шина для передачи управляющей информации и информации о состоянии участвующих в транзакции устройств. 

![](https://sun9-45.userapi.com/impg/hjO6C9CsQs0GDURTiZPIlEJfmE9qfkBwN6WL6A/mZv5xFC3E2Y.jpg?size=1244x287&quality=95&sign=9e3d23c0ce5d21e385c3f6b5024a676d&type=album)
*Рис. 6. Модель системной шины.*

*Какие сигналы могут быть внутри шины управления*:
* 1. Сигналы управления транзакциями (среднее значение сигнальных линий: 2-8) делятся на:
  * указан тип транзакции (чтение\запись);
  * указано количество байт и номер байт, если пересылается часть слова;
  * указан тип адреса выданный на шину.
* 2. Информация состояния (статус) — для передачи кодов ошибок и состояний ( среднее значение сигнальных линий: 1-4).
* 3. Линии арбитража — выюор управляющего шиной устройства (среднее значение сигнальных линий: 3-11).
* 4. Линии прерывания (среднее значение сигнальных линий: 1-2).
* 5. Последовательные локальные сети (среднее значение сигнальных линий: 1-4).
* 6. Линии позиционного кода (среднее значение сигнальных линий: 4-5).
* 7. Тактирование и синхронизация (среднее значение сигнальных линий: 2-6).
* 8. Линии питания и заземления.


В некоторых системах применяют мультиплексированную шину адреса/данных для экономии количества линий, из-за чего повышается скорость передачи информации.
![](https://sun9-27.userapi.com/impg/J9BXv86wR7nQO5LgvwhLZ43EZMqU1RvE-Bc1vQ/yLJEMhACLDg.jpg?size=666x261&quality=95&sign=9495e5e3c1e4ed7d713bb18d4ff21b93&type=album)
*Рис. 7. Мультипрексируемая шина адреса/данных.*

## Иерархия шин

Существует три основных уровня иерархии шин:
* Одноуровневая иерархия:
В этом уровне иерархии медленные устройства занимают системную шину и она не доступна для центрального процесса и памяти.
![](https://sun9-4.userapi.com/impg/o5ENVZA6vuRxEirIOnBmzcqlmD4Gvt-UDqLe7g/mbrxxMK1vhs.jpg?size=338x205&quality=95&sign=6b88b2cf35e0b289a9bc20f3014265d0&type=album)
*Рис. 8. Одноуровневая иерархия.*
* Двухуровневая иерархия:
В данном типе есть адаптеры, к которым подключаются шины. На системной шине "висят" высокопроизводительные элементы системы, а через адаптеры сгруппированы и подключены более медленные внешние устройства. Гланвым минусом является то, что если устройствам модуля ввода\вывода нужно обменяться информацией друг с другом — они будут обмениватья через системную шину, а значит будут её занимать.
![](https://sun9-71.userapi.com/impg/Afzao0QZ2VlV-QnA3Tk_NPTD34kJubtf8hMoZQ/VvvSC5eyMWg.jpg?size=413x318&quality=95&sign=c66907c4b90252aa4075da93c8633c57&type=album)
*Рис. 9. Двухуровневая иерархия.*
* Многоуровневая иерархия:
В этом уровне иерархии существует системная шина для объединения высокопроизводительных элементов, к ней подключен адаптер, который в свою очередь ограничивает другую шину с подключёнными к ней другими адаптерами.
В таком случае, если устройствам модуля ввода\вывода нужно обменяться информацией друг с другом — они будут делать это в обход системной шине. Когда им надо будет выйти на системну шину они смогут сделать это на высокой скорости, потому что есть адаптер, который будет выполнять задачу буферизации.
![](https://sun9-43.userapi.com/impg/yjsAaY7U-WybEC38MRHxZG92FrLjl7l7_m3zFw/YMFozF0qXjw.jpg?size=399x417&quality=95&sign=cc5a359d740e543a58848d81b08a8077&type=album)
*Рис. 10. Многоуровневая иерархия.*

## Арбитраж шин

### Алгоритмы арбитража

Каждому потенциальному 'ведущему' присваивается приоритет для того чтобы дать устройствам возможно обмениваться информацией:
* **Статический приоритет** (за каждым устройством закреплён номер приоритета, чем меньше номер, тем выше приоритет. Проблема заключается в том, что одно устройство может занять шину навсегда и другие устройства не смогут общаться между собой).
* Динамический приоритет (при повторном использовании шины меняется приоритет).
Варианты смен приорита:
   * **Простая циклическая смена приоритетов** (после каждой итерации разыгрывается приоритет и тот, у кого был самый низкий приоритет становится самым высоким).
![](https://sun9-36.userapi.com/impg/wHBken0kejX6R3KQOrE1P7p033-P-5vY3ojjuA/M1LfuY0HmzY.jpg?size=723x195&quality=95&sign=cf1cb4a3ab55425e21ba080a3077112c&type=album)
*Рис. 11. Распределение приоритетов.*
   * **Циклическая смена приоритетов с учётом последнего запроса** (Rotating Daisy Chain — RDC):
Допустим, третье устройство "выигрывает" шину, начинает передавать информацию. После "общения" устройство, которое передавало информацию получает самый низкий приоритет.
   * **Смена приоритетов по случайному закону** (RND):
Приоритеты меняются по закону псевдослучайной последовательности чисел (Псевдослучайная последовательность чисел - это последовательность, которая кажется статистически случайной, несмотря на то, что была получена в результате полностью детерминированного и повторяемого процесса).
   * **Алгоритм наиболее дальнего использования** (LRU):
Приоритет устройства, которое дольше всего не использовали, постепенно возрастает после каждого арбитража шины.
* Можно использоввать **фиксированный квант времени**:
Допустим, у нас есть 10 устройств и каждому из устройств даётся момент времени, когда ему надо определиться хочет ли он общаться или нет. Этот цикл происходит до того момента, пока не найдут готового к общению на шине устройства. Однако скорость реакции на запрос шины будет меньше, чем в других реализациях.
* На основе очереди (FIFO):
Когда одно устройство заканчивает общение на шине — сразу же начинает общение  устройство, которое стоит следующим в очереди. Но FIFO можно легко "забить". Например, пока обрабатываем один запрос ещё 20 других запросов пришло и буфер "забился".

### Схемы арбитража

Схемы арбитража бывают двух типов:
* Централизованный арбитраж (есть устройство, которое называется "арбитр", все устройства подключаются к нему и спрашивают кто из них получит доступ к общению) делится на две категории:
   * Параллельный;
   * Последовательный.
* Децентрализованный арбитраж ("арбитр" у каждого устройства свой).

**Централизованный параллельный арбитраж**.
В этой сехме у нас присутсвуют ведущие устройства, которые могут занимать шину и могут инициировать обмен информацией. Есть центральный арбитр,решающий кто будет общаться на шине. Каждое устройство соединено с арбитром двумя сигналами — это "запрос шины" и "предоставление шины". Все устройства подключены к общей линии "Шина Занята" (ШЗ), с помощью этой линии все устройства могут видеть свободна ли шина или занята. Задача центрального арбитра заключается в определении устройства с максимальным приоритетом и предоставлении шины этому устройству.

![](https://sun9-45.userapi.com/impg/Vou4udev6aZrN7p9LIkmpY6XemDNmJVQ2NI0Gw/_Lk_UOKnyVI.jpg?size=388x335&quality=95&sign=aabf3a2a468477b9fd443df738af8145&type=album)
*Рис. 12.Схема централизованного параллельного арбитража.*

**Централизованный последовательный арбитраж**.
В данной реализации приоритеты фиксированы и зависят от того где конкретно подключено устройство. Есть сигнал "Шина Занята" (ШЗ), есть сигнал "запрос шины" и "предоставление шины" от центрального арбитра.

![](https://sun9-77.userapi.com/impg/473X3ogN7erG6ObCXPFbMde6XDozguvk0Kv4Kg/YaOjZU4lJBQ.jpg?size=558x195&quality=95&sign=c395776d6afe5b27fa47429d8b7fb107&type=album)
*Рис. 13.Схема централизованного последовательного арбитража.*

Для примера рассмотрим ситуацию, когда два устройства одновременно запросили общение на шине ("Ведущий n-2" и "Ведущий 0"). Центральный арбитр видит, что шина не занята и даёт сигнал первому устройству.

![](https://sun9-48.userapi.com/impg/cdGwN5DrXnjsJ6wn9yAgzsviuhLtRneWBhBmmg/l_28fpfDdQQ.jpg?size=727x236&quality=95&sign=42498e34dac8579ee04b2960537ee2c9&type=album)
*Рис. 14.Предоставление сигнала на пользование шиной устройству "Ведущий n-1".*

Первое устройство ("Ведущий n-1") получило этот сигнал, но так как ему не нужно общаться на шине — оно передаёт его следующему устройству ("Ведущий n-2")

![](https://sun9-58.userapi.com/impg/9Cv-ovRVglDAWXmuziMkJ5_ApqJvED2hhAKiNQ/wK_m0B3QQcg.jpg?size=738x237&quality=95&sign=b43e406a773322e8cecc373d16ca8667&type=album)
*Рис. 15.Передача сигнала устройству "Ведущий n-2".*

После этого устройство "Ведущий n-2" не распространяет этот сигнал дальше и занимает шину.

![](https://sun9-58.userapi.com/impg/9Cv-ovRVglDAWXmuziMkJ5_ApqJvED2hhAKiNQ/TXPxYauCwFs.jpg?size=738x237&quality=95&sign=8e29e1b439a45c42e630f9e6f9e393de&type=album)
*Рис. 16.Устройство "Ведущий n-2" заняло шину для общения.*

**Децентрализованный арбитраж**.
В данной реализации все устройства связаны друг с другом проводами. Когда какое-то из устройств хочет занять шину — оно видит сигналы от других устройств. Таким образом, перед тем как выставить совй запрос, устройство смотрит нет ли запросов с большим приоритетом. Если есть, то устройство не отправляет свои запросы, так как это не имеет смысла.

![](https://sun9-43.userapi.com/impg/IC7gt2aMNKYkUcwDNYHDsh-mLQcjcmIobVz6YQ/_S_RUNckWL8.jpg?size=602x229&quality=95&sign=54a48393311d8d0333479a3a6161d569&type=album)
*Рис. 17.Схема децентрализованного арбитража.*

### Протоколы шин

Протоколы шин бывают двух типов:
* синхронные (когда происходит синхроимпульс, тогда происходят и какие-то события на шине);

![](https://sun9-11.userapi.com/impg/t3M_huVlBbEbnOM-R59QIX6WV5vYBi79_flT7A/Bt3mjU9PwZQ.jpg?size=510x187&quality=95&sign=42600edfe8b46083ae0fd3ff013771c6&type=album)
*Рис. 18.Схема синхронного протокола шин.*

* асинхронные (как только устройство способно отреагировать — оно сразу же реагирует).

![](https://sun9-72.userapi.com/impg/x2LqwyB2kCxrRXTN77s-E8Hx8Udr3djfOWHhHw/NrowkX94DZk.jpg?size=548x274&quality=95&sign=3e83a8037723abf0752dd1c22c85799b&type=album)
*Рис. 19.Схема асинхронного протокола шин.*

## Повышение эффективности шин

Методы повышения эффективности шин:
* Пакетный режим пересылки информации (передаётся не одна порция данных, а сразу несколько порций данных по нескольким адресам).

![](https://sun9-70.userapi.com/impg/3hl8dT3Aq53KZ5EvBqAYj_-h4PL4Qu9H56ogig/Qa1Io02VRfY.jpg?size=902x166&quality=95&sign=9732dfbe1f20080eeb6778e76f1b6a0d&type=album)
*Рис. 20.Схема пакетного режима пересылки информации.*

* Конвейеризация транзакций (предназначена для высокоскоростных шин).

![](https://sun9-61.userapi.com/impg/aK1xNSglYjHqgJ3HYivubakCKmb2e1cqSAX5ow/bmquSdSVHMk.jpg?size=471x148&quality=95&sign=b2508dd699a3f401eac4188378bece39&type=album)
*Рис. 21.Схема конвейеризации транзакций.*

Можно менять данные на выходе А ещё до того момента времени , когда эти данные окончательно воспринилсь устройством B, главное выдерживать нужные временные "тайминги"

* Протокол с расщеплением транзакций (мы не ждём ответ на конкретную транзакцию, а выдаём его когда у нас есть возможность).

![](https://sun9-50.userapi.com/impg/Uq55Qrxri68uSUrIQnKylKKAw4_h88b7qQwHNQ/krYuGXx3PPQ.jpg?size=576x94&quality=95&sign=01918e39a4359bdeb958586b0685952d&type=album)жж
*Рис. 22.Схема протокола с расщеплением транзакций.*

Ответ на транзакцию приходит с запросом не сразу. То есть мы не ждём ответ на конкретную транзакцию, и выдаём ответ когда есть возможность.
Например, на рисунке 21 для *адреса 1* у нас была возможность получить ответ сразу, так же и с *адресами 3 и 4*, а вот для *адреса 2* возможность получить ответ появилась только получения ответов для *адреса 3 и 4*. Таким образом, за счёт протокола с расщеплением транзакций всё будеть работать корректно.

* Арбитраж с перекрытием (очередной арбитраж происходит ещё на стадии передачи прошлой информации).

Очередной арбитраж происходит ещё на стадии передачи прошлой информации.
Допустим, "разыграли" шину и мы ей завладели, затем другое устройство сообщает, что хочет завладеть этой шиной. Вместо того чтобы он просто ждал — включается арбитр и определяет, можно ли будет этому устройству завладеть шиной или нельзя. Как только заканчивается передача, сразу же идёт переключение на другое устройство.

* Арбитраж с удержанием шины (ведущее устройство захватывает шину и начинает передавать большое количество информации, то есть передача шины происходит только при возникновении запроса)

Например, ведущее устройство захватывает шину и начинает передавать **большое количество информации**. Это устройство передаёт информацию и видит, что другие устройства не отправляют запрос на пользование шиной, тогда ведущее устройство продолжает передавать информацию. То есть когда возникнет запрос, тогда устройство сразу передаёт шину.

### Увеличение полосы пропускания

Для увеличения полосы пропускания существуют следующие способы:
* отказ от мультиплексирования шин адреса и данных;
* увеличение ширины данных;
* повышение тактовой частоты.

### Стандартизация шин

Из стандартизированных шин можно выделить две большие группы:

* Шины "большого" интерфейса (высокопроизводительные шины, связывают память, процессор, модули ввода\вывода)
   * PCI Express
   * Hyper Transport
   * QPI
 
* Шины "малого" интерфейса (служат для присоединения периферийных устройств к модулям ввода\вывода)
   * USB
   * Bluetooth
   * UART
   * CAN
   * SPI
   * I2C

### Последовательный синхронный обмен

![](https://sun9-60.userapi.com/impg/hayCR2H4MPqWRhtkIjLtVr_q0pmcWC51rqbKbw/Kkrx0EHFruY.jpg?size=615x290&quality=95&sign=944cfcd79a7ae1763d9667a52c129b85&type=album)
*Рис. 23.Схема последовательного синхронного обмена.*

Для того чтобы организовать последовательный синхронный обмен информации, нам нужна линия, по которой мы передаём информацию, линия, по которой происходит синхронизация.

Как работает последовательный синхронный обмен:
На схеме есть генератор импульсов (ГН), который генерирует тактовый сигнал (он управляет сдвиговым регистром и передаёт сигналы на приёмник). Предачик параллельно с этим загружает информацию в сдвиговый регистр, затем информация по одному биту перемещается в другой сдвиговый регистр. После того как вся информация передалась — приёмник просто считывает эту информацию

### Последовательный асинхронный обмен

![](https://sun9-19.userapi.com/impg/1ZzlAVMwuT7vNIt6ICLy_vM94dlhi64w8HS1dA/ILBqtsqffIw.jpg?size=667x296&quality=95&sign=0ad084d97d83ddcae8500d2dd13888d7&type=album)
*Рис. 24.Схема последовательного асинхронного обмена.*

Отличие от последовательного синхронного обмена заключается в том, что из-за отсутствия тактовых импульсов приёмнику и передатчику необходимо договориться про скорость, на которой будет происходить обмен. На нашей схеме генератор импульсов на приёмнике в 16 раз выше частотой чем на передатчике. Схема управления будет 16 раз считывать каждый бит, то есть если 14 раз была единица и 2 раза ноль, значит была единица.




### Основные материалы лекции
1. [Ссылка](https://www.youtube.com/watch?v=UXmY3LS_xWk&list=PL0def37HEo5KHPjwK7A5bd4RJGg4djPVf&index=23) на видеозапись лекции
2. [Ссылка](https://onedrive.live.com/view.aspx?resid=1FF28DEC684C2C56!81737&cid=1ff28dec684c2c56&authkey=!AIXUSz0MyutL6hs&CT=1698668305325&OR=ItemsView) на лекцию в формате Power Point
